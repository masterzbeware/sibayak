-- ✅ Obsidian UI Setup
local repo = "https://raw.githubusercontent.com/deividcomsono/Obsidian/main/"
local Library = loadstring(game:HttpGet(repo .. "Library.lua"))()

Library.ForceCheckbox = false
Library.ShowToggleFrameInKeybinds = true

local Window = Library:CreateWindow({
    Title = "Bug Hunter",
    Footer = "by MasterZ",
    Icon = 0,
    NotifySide = "Right",
    ShowCustomCursor = true,
})

-- ✅ Tabs dan GroupBoxes
local Tabs = { Main = Window:AddTab("Main", "user") }
local GroupBox = Tabs.Main:AddLeftGroupbox("Tenda Follow")
local CallBox = Tabs.Main:AddRightGroupbox("Spam Telepon")
local CarryBox = Tabs.Main:AddLeftGroupbox("Carry Request")
local EffectBox = Tabs.Main:AddRightGroupbox("Efek Tenda")

local CallingLabel = CallBox:AddLabel("Sedang menelepon: -")
local CarryingLabel = CarryBox:AddLabel("Sedang carry request: -")

-- ✅ Global Variables
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer

local running = false
local carryRunning = false
local spamCallRunning = false
local blinkRunning = false
local rotateRunning = false
local targetName = ""
local followDelay = 0.5
local blinkDelay = 0.15
local rotateDelay = 0.2
local followTarget = nil

-- ✅ Utility
local function getPlayerNames()
    local list = {}
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            table.insert(list, player.DisplayName .. " [" .. player.Name .. "]")
        end
    end
    return list
end

local function deleteTenda()
    ReplicatedStorage:WaitForChild("uxrPlacementSystem#RS@4.0")
        :WaitForChild("placementEvents"):WaitForChild("RemoteEvent")
        :FireServer("uxrDeleteEvent", "Tenda")
end

local function spawnTendaAt(pos)
    local args = {
        "uxrPlaceEvent", "Tenda",
        pos.X, pos.Y, pos.Z,
        0.538154125213623, 0, 0.8428464531898499,
        0, 1, 0,
        -0.8428464531898499, 0, 0.538154125213623
    }
    ReplicatedStorage:WaitForChild("uxrPlacementSystem#RS@4.0")
        :WaitForChild("placementEvents"):WaitForChild("RemoteEvent")
        :FireServer(unpack(args))
end

local function hasMoved(a, b)
    return (a - b).Magnitude > 1
end

local function followTargetPlayer(player)
    if not player then return end
    followTarget = player

    local function follow(char)
        local hrp = char:WaitForChild("HumanoidRootPart")
        local lastPos = hrp.Position
        spawnTendaAt(lastPos)

        local humanoid = char:FindFirstChildOfClass("Humanoid")
        local diedConn
        if humanoid then
            diedConn = humanoid.Died:Connect(function()
                deleteTenda()
                Library:Notify("Target mati. Pause follow.", 3)
            end)
        end

        while running and followTarget == player and player.Character and player.Character:FindFirstChild("HumanoidRootPart") do
            task.wait(followDelay)
            local newPos = player.Character.HumanoidRootPart.Position
            if hasMoved(lastPos, newPos) then
                deleteTenda()
                spawnTendaAt(newPos)
                lastPos = newPos
            end
        end

        if diedConn then diedConn:Disconnect() end
    end

    if player.Character then task.spawn(function() follow(player.Character) end) end

    player.CharacterAdded:Connect(function(char)
        if running and followTarget == player then
            Library:Notify("Target respawn. Lanjut follow.", 3)
            task.wait(1)
            task.spawn(function() follow(char) end)
        end
    end)
end

-- ✅ FOLLOW UI
GroupBox:AddInput("TargetName", {
    Default = "", Text = "Nama Target Manual", Placeholder = "Contoh: Player123",
    Tooltip = "Masukkan DisplayName/Username target",
    Callback = function(v) targetName = v end
})

local dropdown = GroupBox:AddDropdown("TargetDropdown", {
    Values = getPlayerNames(), Multi = false,
    Text = "Pilih Target dari List", Tooltip = "Langsung pilih dari pemain",
    Callback = function(v)
        local name = string.match(v, "%[(.-)%]$")
        if name then targetName = name end
    end
})

GroupBox:AddButton("Refresh Player List", function()
    dropdown:SetValues(getPlayerNames())
    Library:Notify("Player list diperbarui", 3)
end)

GroupBox:AddInput("FollowDelay", {
    Default = "0.5", Text = "Delay (detik)",
    Placeholder = "Contoh: 0.2",
    Callback = function(v)
        local n = tonumber(v)
        if n then followDelay = n end
    end
})

GroupBox:AddButton("Cancel Follow", function()
    running = false
    followTarget = nil
    deleteTenda()
    Library:Notify("Follow dihentikan", 3)
end)

GroupBox:AddToggle("FollowTenda", {
    Text = "Aktifkan Follow Tenda", Default = false,
    Callback = function(state)
        running = state
        if state then
            if targetName == "" then
                Library:Notify("Isi atau pilih nama target dulu.", 3)
                return
            end
            for _, p in ipairs(Players:GetPlayers()) do
                if p.Name:lower() == targetName:lower() or p.DisplayName:lower() == targetName:lower() then
                    followTarget = p
                    Library:Notify("Following: " .. p.Name, 3)
                    task.spawn(function() followTargetPlayer(p) end)
                    return
                end
            end
            Library:Notify("Target tidak ditemukan.", 3)
        else
            running = false
            followTarget = nil
            deleteTenda()
            Library:Notify("Follow dimatikan", 3)
        end
    end
})

-- ✅ Auto Rejoin Support
Players.PlayerRemoving:Connect(function(p)
    if followTarget and p == followTarget then
        deleteTenda()
        Library:Notify("Target keluar. Menunggu rejoin...", 3)
    end
end)

Players.PlayerAdded:Connect(function(p)
    if targetName == "" then return end
    if p.Name:lower() == targetName:lower() or p.DisplayName:lower() == targetName:lower() then
        followTarget = p
        Library:Notify("Target rejoin. Melanjutkan follow...", 3)
        task.wait(1)
        running = true
        task.spawn(function() followTargetPlayer(p) end)
    end
end)

-- ✅ Leave Room
local function leaveRoom()
    ReplicatedStorage:WaitForChild("EdenShared"):WaitForChild("Modules")
        :WaitForChild("Remote"):WaitForChild("RemoteFunction")
        :InvokeServer("Phone", "LeaveRoom")
end

-- ✅ Spam Call
local function spamInviteLoop()
    spamCallRunning = true
    while spamCallRunning do
        for _, p in ipairs(Players:GetPlayers()) do
            if not spamCallRunning then break end
            if p ~= LocalPlayer then
                CallingLabel:SetText("Calling: " .. p.DisplayName .. " [" .. p.Name .. "]")
                ReplicatedStorage:WaitForChild("EdenShared"):WaitForChild("Modules")
                    :WaitForChild("Remote"):WaitForChild("RemoteFunction")
                    :InvokeServer("Phone", "InviteToRoom", p)
                task.wait(0.6)
                leaveRoom()
                task.wait(0.4)
            end
        end
    end
    CallingLabel:SetText("Call stopped.")
end

CallBox:AddButton("Start Spam Call", function()
    if not spamCallRunning then
        task.spawn(spamInviteLoop)
        Library:Notify("Mulai spam telepon...", 3)
    end
end)

CallBox:AddButton("Stop Call", function()
    spamCallRunning = false
    CallingLabel:SetText("Call stopped.")
    Library:Notify("Spam telepon dihentikan.", 3)
end)

-- ✅ Spam Carry
local function spamCarryLoop()
    carryRunning = true
    while carryRunning do
        for _, p in ipairs(Players:GetPlayers()) do
            if not carryRunning then break end
            if p ~= LocalPlayer then
                ReplicatedStorage:WaitForChild("CarryRequest"):FireServer("Request", p)
                CarryingLabel:SetText("Request ke: " .. p.DisplayName .. " [" .. p.Name .. "]")
                task.wait(0.4)
            end
        end
    end
    CarryingLabel:SetText("Carry request stopped.")
end

CarryBox:AddButton("Start Spam Carry", function()
    if not carryRunning then
        task.spawn(spamCarryLoop)
        Library:Notify("Mulai spam carry...", 3)
    end
end)

CarryBox:AddButton("Stop Spam Carry", function()
    carryRunning = false
    CarryingLabel:SetText("Carry request stopped.")
    Library:Notify("Spam carry dihentikan.", 3)
end)

-- ✅ Efek Blink & Rotasi
EffectBox:AddToggle("BlinkTenda", {
    Text = "Blink/Flash Tenda", Default = false,
    Callback = function(state)
        blinkRunning = state
        if state then
            Library:Notify("Blink dimulai", 3)
            task.spawn(function()
                while blinkRunning do
                    deleteTenda()
                    local pos = (followTarget and followTarget.Character and followTarget.Character:FindFirstChild("HumanoidRootPart"))
                        and followTarget.Character.HumanoidRootPart.Position
                        or (LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") and LocalPlayer.Character.HumanoidRootPart.Position)
                        or Vector3.new()
                    spawnTendaAt(pos)
                    task.wait(blinkDelay)
                end
            end)
        else
            deleteTenda()
            Library:Notify("Blink dihentikan", 3)
        end
    end
})

EffectBox:AddInput("BlinkDelayInput", {
    Default = tostring(blinkDelay),
    Text = "Kecepatan Blink (detik)",
    Placeholder = "Contoh: 0.1",
    Callback = function(v)
        local n = tonumber(v)
        if n then
            blinkDelay = n
            Library:Notify("Blink delay: " .. blinkDelay, 3)
        end
    end
})

EffectBox:AddToggle("RotateTenda", {
    Text = "Putar-Putar Tenda", Default = false,
    Callback = function(state)
        rotateRunning = state
        if state then
            Library:Notify("Rotasi dimulai", 3)
            task.spawn(function()
                local angle = 0
                while rotateRunning do
                    deleteTenda()
                    local pos = (followTarget and followTarget.Character and followTarget.Character:FindFirstChild("HumanoidRootPart"))
                        and followTarget.Character.HumanoidRootPart.Position
                        or (LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") and LocalPlayer.Character.HumanoidRootPart.Position)
                        or Vector3.new()
                    local rad = math.rad(angle)
                    local cos, sin = math.cos(rad), math.sin(rad)
                    ReplicatedStorage:WaitForChild("uxrPlacementSystem#RS@4.0")
                        :WaitForChild("placementEvents"):WaitForChild("RemoteEvent")
                        :FireServer("uxrPlaceEvent", "Tenda", pos.X, pos.Y, pos.Z, cos, 0, sin, 0, 1, 0, -sin, 0, cos)
                    angle = (angle + 30) % 360
                    task.wait(rotateDelay)
                end
            end)
        else
            deleteTenda()
            Library:Notify("Rotasi dihentikan", 3)
        end
    end
})

EffectBox:AddInput("RotateDelayInput", {
    Default = tostring(rotateDelay),
    Text = "Kecepatan Putar (detik)",
    Placeholder = "Contoh: 0.2",
    Callback = function(v)
        local n = tonumber(v)
        if n then
            rotateDelay = n
            Library:Notify("Rotasi delay: " .. rotateDelay, 3)
        end
    end
})
