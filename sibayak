-- ✅ Obsidian UI Setup
local repo = "https://raw.githubusercontent.com/deividcomsono/Obsidian/main/"
local Library = loadstring(game:HttpGet(repo .. "Library.lua"))()

Library.ForceCheckbox = false
Library.ShowToggleFrameInKeybinds = true

local Window = Library:CreateWindow({
    Title = "Tenda Follower UI",
    Footer = "by MasterZ",
    Icon = 0,
    NotifySide = "Right",
    ShowCustomCursor = true,
})

local Tabs = {
    Main = Window:AddTab("Main", "user"),
    Info = Window:AddTab("Info", "info-circle")
}

local GroupBox = Tabs.Main:AddLeftGroupbox("Tenda Follow")
local CallBox = Tabs.Main:AddRightGroupbox("Spam Telepon")
local CarryBox = Tabs.Main:AddLeftGroupbox("Carry Request")
local InfoBox = Tabs.Info:AddLeftGroupbox("Status / Keterangan")

local CallingLabel = CallBox:AddLabel("Sedang menelepon: -")
local CarryingLabel = CarryBox:AddLabel("Sedang carry request: -")

-- ✅ Global Variables
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer

local running = false
local carryRunning = false
local spamCallRunning = false
local targetName = ""
local followDelay = 0.5
local followTarget = nil

-- ✅ Functions
local function getPlayerNames()
    local list = {}
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            table.insert(list, player.DisplayName .. " [" .. player.Name .. "]")
        end
    end
    return list
end

local function deleteTenda()
    local args = { "uxrDeleteEvent", "Tenda" }
    ReplicatedStorage:WaitForChild("uxrPlacementSystem#RS@4.0")
        :WaitForChild("placementEvents"):WaitForChild("RemoteEvent")
        :FireServer(unpack(args))
end

local function spawnTendaAt(pos)
    local args = {
        "uxrPlaceEvent", "Tenda",
        pos.X, pos.Y, pos.Z,
        0.538154125213623, 0, 0.8428464531898499,
        0, 1, 0,
        -0.8428464531898499, 0, 0.538154125213623
    }
    ReplicatedStorage:WaitForChild("uxrPlacementSystem#RS@4.0")
        :WaitForChild("placementEvents"):WaitForChild("RemoteEvent")
        :FireServer(unpack(args))
end

local function hasMoved(lastPos, newPos)
    return (lastPos - newPos).Magnitude > 1
end

local function followTargetPlayer(targetPlayer)
    followTarget = targetPlayer

    local function follow(char)
        local hrp = char:WaitForChild("HumanoidRootPart")
        local lastPos = hrp.Position
        spawnTendaAt(lastPos)

        local humanoid = char:FindFirstChildOfClass("Humanoid")
        local diedConnection
        if humanoid then
            diedConnection = humanoid.Died:Connect(function()
                deleteTenda()
                Library:Notify("Target died. Tent follow paused.", 3)
            end)
        end

        while running and targetPlayer and targetPlayer.Character and targetPlayer.Character:FindFirstChild("HumanoidRootPart") do
            task.wait(followDelay)
            local newPos = targetPlayer.Character.HumanoidRootPart.Position
            if hasMoved(lastPos, newPos) then
                deleteTenda()
                spawnTendaAt(newPos)
                lastPos = newPos
            end
        end

        if diedConnection then
            diedConnection:Disconnect()
        end
    end

    if targetPlayer.Character then
        task.spawn(function()
            follow(targetPlayer.Character)
        end)
    end

    targetPlayer.CharacterAdded:Connect(function(newChar)
        if running then
            Library:Notify("Target respawned. Resuming follow.", 3)
            task.wait(1)
            task.spawn(function()
                follow(newChar)
            end)
        end
    end)
end

-- ✅ UI FOLLOW TENDA
GroupBox:AddInput("TargetName", {
    Default = "",
    Numeric = false,
    Finished = false,
    Text = "Nama Target Manual",
    Tooltip = "Masukkan DisplayName/Username target",
    Placeholder = "Contoh: Player123",
    Callback = function(value)
        targetName = value
    end
})

local playerDropdown = GroupBox:AddDropdown("TargetDropdown", {
    Values = getPlayerNames(),
    Multi = false,
    Text = "Pilih Target dari List",
    Tooltip = "Lebih mudah pilih pemain langsung",
    Callback = function(value)
        local name = string.match(value, "%[(.-)%]$")
        if name then targetName = name end
    end
})

GroupBox:AddButton("Refresh Player List", function()
    local newList = getPlayerNames()
    playerDropdown:SetValues(newList)
    Library:Notify("Player list updated.", 3)
end)

GroupBox:AddInput("FollowDelay", {
    Default = "0.5",
    Numeric = false,
    Finished = true,
    Text = "Delay (detik)",
    Tooltip = "Delay pergerakan tenda mengikuti target",
    Placeholder = "Contoh: 0.2",
    Callback = function(value)
        local num = tonumber(value)
        if num then followDelay = num end
    end
})

GroupBox:AddButton("Cancel Follow", function()
    running = false
    deleteTenda()
    Library:Notify("Follow stopped and tent removed.", 3)
end)

GroupBox:AddToggle("FollowTenda", {
    Text = "Aktifkan Follow Tenda",
    Default = false,
    Tooltip = "Tenda akan mengikuti target yang dimasukkan",
    Callback = function(state)
        running = state
        if state then
            if targetName == "" then
                Library:Notify("Please enter or select a target name first.", 3)
                return
            end
            local targetPlayer = nil
            for _, player in ipairs(Players:GetPlayers()) do
                if player.Name:lower() == targetName:lower() or player.DisplayName:lower() == targetName:lower() then
                    targetPlayer = player
                    break
                end
            end
            if targetPlayer then
                Library:Notify("Following: " .. targetPlayer.Name, 3)
                task.spawn(function()
                    followTargetPlayer(targetPlayer)
                end)
            else
                Library:Notify("Target player not found.", 3)
            end
        else
            running = false
            deleteTenda()
            Library:Notify("Follow disabled. Tent removed.", 3)
        end
    end,
})

-- ✅ Target keluar server
Players.PlayerRemoving:Connect(function(leavingPlayer)
    if running and followTarget and leavingPlayer == followTarget then
        running = false
        deleteTenda()
        Library:Notify("Target left the game. Follow stopped.", 3)
    end
end)

-- ✅ Target join ulang
Players.PlayerAdded:Connect(function(joinedPlayer)
    if targetName == "" or not running then return end
    if joinedPlayer.Name:lower() == targetName:lower() or joinedPlayer.DisplayName:lower() == targetName:lower() then
        Library:Notify("Target rejoined. Resuming follow.", 3)
        task.wait(1)
        task.spawn(function()
            followTargetPlayer(joinedPlayer)
        end)
    end
end)

-- ✅ Fungsi leave room
local function leaveRoom()
    local args = { "Phone", "LeaveRoom" }
    ReplicatedStorage:WaitForChild("EdenShared"):WaitForChild("Modules")
        :WaitForChild("Remote"):WaitForChild("RemoteFunction"):InvokeServer(unpack(args))
end

-- ✅ Spam Telepon
local function spamInviteLoop()
    spamCallRunning = true
    while spamCallRunning do
        local playersList = Players:GetPlayers()
        for _, player in ipairs(playersList) do
            if not spamCallRunning then break end
            if player ~= LocalPlayer then
                CallingLabel:SetText("Calling: " .. player.DisplayName .. " [" .. player.Name .. "]")
                local args = { "Phone", "InviteToRoom", player }
                ReplicatedStorage:WaitForChild("EdenShared"):WaitForChild("Modules")
                    :WaitForChild("Remote"):WaitForChild("RemoteFunction"):InvokeServer(unpack(args))
                task.wait(0.6)
                leaveRoom()
                task.wait(0.4)
            end
        end
    end
    CallingLabel:SetText("Call stopped.")
end

CallBox:AddButton("Start Spam Call", function()
    if not spamCallRunning then
        task.spawn(spamInviteLoop)
        Library:Notify("Starting call spam loop...", 3)
    end
end)

CallBox:AddButton("Stop Call", function()
    spamCallRunning = false
    CallingLabel:SetText("Call stopped.")
    Library:Notify("Call spam stopped.", 3)
end)

-- ✅ Spam Carry
local function spamCarryLoop()
    carryRunning = true
    while carryRunning do
        for _, player in ipairs(Players:GetPlayers()) do
            if not carryRunning then break end
            if player ~= LocalPlayer then
                local args = { "Request", player }
                ReplicatedStorage:WaitForChild("CarryRequest"):FireServer(unpack(args))
                CarryingLabel:SetText("Sending carry request to: " .. player.DisplayName .. " [" .. player.Name .. "]")
                task.wait(0.4)
            end
        end
    end
    CarryingLabel:SetText("Carry request stopped.")
end

CarryBox:AddButton("Start Spam Carry", function()
    if not carryRunning then
        task.spawn(spamCarryLoop)
        Library:Notify("Starting carry request spam...", 3)
    end
end)

CarryBox:AddButton("Stop Spam Carry", function()
    carryRunning = false
    CarryingLabel:SetText("Carry request stopped.")
    Library:Notify("Carry spam stopped.", 3)
end)

-- ✅ Info Tab - Tanpa Emoji, Rapi, Profesional
InfoBox:AddLabel("Script developed by MasterZ")
InfoBox:AddLabel("Phone Spam: Loops call and exits room automatically")
InfoBox:AddLabel("Carry Spam: Repeated carry requests to all players")
InfoBox:AddLabel("Tent Follow: Automatically follows target after death or rejoin")
InfoBox:AddLabel("Interface powered by Obsidian UI Framework")
